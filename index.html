
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cadastro de Pacientes — Integrada Neuropsicologia</title>
  <meta name="description" content="Login e cadastro de pacientes com liberação de testes por SheetDB." />
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --pri:#4f46e5; --line:#1f2937;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .wrap{max-width:960px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:20px}
    h1,h2{margin:0 0 12px}
    h1{font-size:1.4rem}
    h2{font-size:1.05rem;color:var(--muted)}
    label{display:block;font-weight:600;margin:10px 0 6px}
    input,button,select{font:inherit}
    input[type="text"],input[type="password"],input[type="date"],input[type="email"],input[type="tel"]{
      width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:#fff
    }
    select{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:#fff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .btn{display:inline-flex;align-items:center;gap:10px;background:var(--pri);border:none;color:#fff;padding:12px 16px;border-radius:10px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.sec{background:#334155}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .msg{margin:10px 0;padding:10px;border-radius:8px}
    .msg.ok{background:#052e1a;color:#b3f7c1;border:1px solid #114d2a}
    .msg.err{background:#3b0d0d;color:#ffd0d0;border:1px solid #5b1919}
    .msg.warn{background:#3a2903;color:#ffe6b0;border:1px solid #5c4307}
    .grid-tests{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px;margin-top:10px}
    .check{display:flex;align-items:flex-start;gap:10px;padding:10px;border:1px solid var(--line);border-radius:10px;background:#0b1220}
    .check small{display:block;color:var(--muted)}
    .tag{ font-size:.75rem; padding:2px 8px; border-radius:999px; border:1px solid var(--line); color:var(--muted) }
.tag.ok{   background:#09331b; color:#9af0b1; border-color:#124d29 }
.tag.done{ background:#07263a; color:#b9e7ff; border-color:#0a3c66 }
.tag.new{  background:#2a2a2a }

    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .topbar .brand{font-weight:700}
    .hidden{display:none !important}
    @media (max-width:720px){.row,.row3{grid-template-columns:1fr}}
   
.check{ align-items:flex-start; }                 
.check input[type="checkbox"]{
  width:18px; height:18px;
  margin-top:4px;
}
.check .box{ flex:1; min-width:0; }              
.check .code{
  font-weight:700;
  font-size:1rem;
  line-height:1.3;
  overflow-wrap:anywhere;
  word-break:break-word;
}
.check .title{
  font-weight:600;
  font-size:.92rem;
  font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
  color:var(--muted);
  letter-spacing:.02em;
  overflow-wrap:anywhere;
  word-break:break-word;
}

.tag{ flex-shrink:0; }                            /* a tag de status não espreme o texto */
/* === Cores por respondente === */
:root{
  --src-paciente:#22c55e;
  --src-pais:#f59e0b;
  --src-professores:#3a92ff;
  --src-familiares:#dd00ff;
  --src-profissional:#ec0808; /* troque se quiser outra cor */
}
/* Base dos cards já existe (.check). Vamos só colorir por classe */
.check{
  position:relative;
  display:flex;
  flex-direction:column;      /* empilha */
  align-items:flex-start;
  gap:8px;
  padding:12px;
  border:1px solid var(--line);
  border-radius:10px;
  background:#0b1220;
}

/* Badge com o nome do respondente no canto direito */
.check::after{
  content:attr(data-source-label);
  position:absolute; top:8px; right:8px;
  font-size:.7rem; padding:2px 8px;
  border-radius:999px; border:1px solid var(--line);
  background:rgba(255,255,255,.06); color:var(--muted);
}


.check.src-paciente{    border-left:6px solid var(--src-paciente);    box-shadow: inset 0 0 0 1px rgba(34,197,94,.15); }
.check.src-pais{        border-left:6px solid var(--src-pais);        box-shadow: inset 0 0 0 1px rgba(245,158,11,.15); }
.check.src-professores{ border-left:6px solid var(--src-professores); box-shadow: inset 0 0 0 1px rgba(96,165,250,.15); }
.check.src-familiares{  border-left:6px solid var(--src-familiares);  box-shadow: inset 0 0 0 1px rgba(232,121,249,.15); }
.check.src-profissional{border-left:6px solid var(--src-profissional);box-shadow: inset 0 0 0 1px rgba(255,251,11,.15); }
.check::after{ content:none !important; }
.meta{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}

/* (Opcional) mini-legenda horizontal */
.legend{display:flex;gap:8px;flex-wrap:wrap;align-items:center;font-size:.8rem;color:var(--muted)}
.legend .chip{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#0b1220}
.legend .dot{width:10px;height:10px;border-radius:50%}
.legend .dot.paciente{background:var(--src-paciente)}
.legend .dot.pais{background:var(--src-pais)}
.legend .dot.professores{background:var(--src-professores)}
.legend .dot.familiares{background:var(--src-familiares)}
.legend .dot.profissional{background:var(--src-profissional)}

/* === Corrige sobreposição: desativa o ::after do respondente === */


/* Permite quebrar para duas linhas se faltar espaço */
.check{ position:relative; flex-wrap:wrap; gap:10px; }

/* Mantém o texto ocupando o espaço principal */
.check .box{ flex:1 1 auto; min-width:0; }

/* Chips (respondente + status) não “apertam” o texto */
.srcchip, .tag{ flex-shrink:0; }
.srcchip{
  display:inline-flex; align-items:center; gap:6px;
  font-size:.72rem; padding:2px 8px;
  border:1px solid var(--line); border-radius:999px;
  background:#0b1220; color:var(--muted);
}
.srcchip::before{ content:""; width:10px; height:10px; border-radius:50%; }

/* Cores do pontinho do chip por tipo */
.srcchip.paciente::before{    background:var(--src-paciente); }
.srcchip.pais::before{        background:var(--src-pais); }
.srcchip.professores::before{ background:var(--src-professores); }
.srcchip.familiares::before{  background:var(--src-familiares); }
.srcchip.profissional::before{background:var(--src-profissional); }



  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">Integrada Neuropsicologia — Painel</div>
      <div><button id="btnLogout" class="btn sec hidden">Sair</button></div>
    </div>

    <!-- LOGIN -->
    <section id="viewLogin" class="card">
      <h1>Entrar</h1>
      <p class="muted">Use seu usuário e senha cadastrados na aba <strong>Auth</strong>.</p>
      <div class="row">
        <div><label>Usuário</label><input id="loginUser" type="text" autocomplete="username" /></div>
        <div><label>Senha</label><input id="loginPass" type="password" autocomplete="current-password" /></div>
      </div>
      <div class="toolbar"><button id="btnLogin" class="btn">Entrar</button></div>
      <div id="loginMsg" class="msg hidden"></div>
    </section>




    <!-- APP -->
    <section id="viewApp" class="card hidden">
  <h1>Cadastro de Paciente</h1>

  <!-- BLOCO 1: SOMENTE CPF (fica sempre visível após login) -->
  <div id="cpfLookup" class="row" style="margin-top:8px;">
    <div>
      <label>CPF (somente números)</label>
      <input id="pacCPF" type="text" inputmode="numeric" maxlength="14" placeholder="000.000.000-00" />
    </div>
  </div>
  <div class="toolbar" id="lookupBar">
    <button id="btnBuscar" class="btn sec">Buscar/Carregar por CPF</button>
    <button id="btnCopyLink" class="btn sec">Copiar link</button>
  </div>

  <div id="pacMsg" class="msg hidden"></div>

  <!-- BLOCO 2: FORM DE DADOS (apenas quando CPF existe ou para novo cadastro) -->
  <div id="pacForm" class="hidden">
    <h2>Dados do paciente</h2>
    <div class="row">
      <div><label>Nome completo</label><input id="pacNome" type="text" placeholder="Ex.: Ana Paula Gomes do Nascimento" /></div>
      <div><label>Data de nascimento</label><input id="pacNasc" type="date" /></div>
    </div>
    <div class="row">
      <div><label>E-mail</label><input id="pacEmail" type="email" placeholder="nome@exemplo.com" autocomplete="email" /></div>
      <div><label>WhatsApp (DDD + número)</label><input id="pacWhats" type="tel" inputmode="numeric" placeholder="(41) 9 9999-9999" /></div>
    </div>

    <div class="toolbar" id="formBar">
      <button id="btnSalvar" class="btn">Salvar</button>
    </div>
  </div>

  <!-- BLOCO 3: TESTES (apenas quando CPF existe OU para liberar testes no novo cadastro) -->
  <div id="testsWrap" class="hidden">
    <h2 style="margin-top:18px;">Testes</h2>
    <div class="toolbar" style="margin-bottom:6px;">
      <label for="statusFilter" style="margin:0;align-self:center;">Filtrar por status</label>
      <select id="statusFilter" aria-label="Filtrar por status">
        <option value="todos">Todos</option>
        <option value="cadastrar">Cadastrar</option>
        <option value="ja">Já registrados</option>
        <option value="preenchido">Preenchido</option>
      </select>
      <div id="testsInfo" class="tag new">carregando catálogo…</div>
      <div class="legend" style="margin-top:4px;">
  <span>Respondente:</span>
  <span class="chip"><span class="dot paciente"></span> Paciente</span>
  <span class="chip"><span class="dot pais"></span> Pais/Cuidadores</span>
  <span class="chip"><span class="dot professores"></span> Professores</span>
  <span class="chip"><span class="dot familiares"></span> Familiares/Amigos</span>
  <span class="chip"><span class="dot profissional"></span> Profissional</span>
</div>
    </div>
    <div id="testsGrid" class="grid-tests" aria-live="polite"></div>
  </div>
  
</section>

  </div>

<script>
/* ===== CONFIG ===== */
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { AUTH:"Auth", TESTS:"Tests", PATIENTS:"Patients", TOKENS:"LinkTokens" };
const PATIENT_PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios";

/* ===== HELPERS ===== */
const $ = s => document.querySelector(s);
const el = (t,o={}) => Object.assign(document.createElement(t),o);
function show(n){ n.classList.remove("hidden"); }
function hide(n){ n.classList.add("hidden"); }
function enterLookupMode(){
  // limpa estado e mostra só o CPF + barra de busca
  hide($("#pacForm"));
  hide($("#testsWrap"));
  show($("#lookupBar"));
  setMsg($("#pacMsg"), "");
  // limpa campos (menos o CPF)
  $("#pacNome").value = "";
  $("#pacNasc").value = "";
  $("#pacEmail").value = "";
  $("#pacWhats").value = "";
}



function setMsg(b,t,ty="ok"){ b.textContent=t; b.className="msg "+(ty||""); t?show(b):hide(b); }
function onlyDigits(s){ return (s||"").replace(/\D+/g,""); }
function validaCPF(cpf){
  cpf = onlyDigits(cpf);
  if (!cpf || cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;
  let soma=0, resto;
  for(let i=1;i<=9;i++) soma += parseInt(cpf.substring(i-1,i))*(11-i);
  resto=(soma*10)%11; if(resto===10||resto===11) resto=0;
  if(resto !== parseInt(cpf.substring(9,10))) return false;
  soma=0; for(let i=1;i<=10;i++) soma += parseInt(cpf.substring(i-1,i))*(12-i);
  resto=(soma*10)%11; if(resto===10||resto===11) resto=0;
  return resto === parseInt(cpf.substring(10,11));
}
function toISODateFromInput(s){ return s || ""; }
function nowDateTimeLocal(){ const d=new Date(),p=n=>(n<10?'0':'')+n; return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`; }
function isValidEmail(s){ return !!(s && /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(s.trim())); }
function normalizeWhats(input){
  if(!input) return "";
  let d = onlyDigits(input);
  if(!d) return "";
  if(d.startsWith("55") && d.length>=12 && d.length<=13) return "+"+d;
  if(d.length===10 || d.length===11) return "+55"+d;
  if(d.length>=12 && d.length<=13) return "+"+d;
  return "";
}
function formatWhatsInput(el){
  let d = onlyDigits(el.value).slice(0,13);
  if(d.startsWith("55")) d = d.slice(2);
  if(d.length<=2){ el.value=d; return; }
  const ddd=d.slice(0,2); let rest=d.slice(2);
  if(rest.length>=9) el.value = `(${ddd}) ${rest[0]} ${rest.slice(1,5)}-${rest.slice(5,9)}`;
  else if(rest.length>=5) el.value = `(${ddd}) ${rest.slice(0,4)}-${rest.slice(4,8)}`;
  else el.value = `(${ddd}) ${rest}`;
}
$("#pacWhats").addEventListener("input", ()=> formatWhatsInput($("#pacWhats")));

/* ===== SheetDB ===== */
async function sheetSearch(sheet, params){
  const usp = new URLSearchParams(params);
  const url = `${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`;
  const r = await fetch(url); if(!r.ok) throw new Error("Falha ao buscar em "+sheet); return r.json();
}
async function sheetCreate(sheet, row){
  const url = `${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`;
  const r = await fetch(url,{ method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ data:[row] }) });
  if(!r.ok){ const t=await r.text(); throw new Error("Falha ao criar: "+t); } return r.json();
}
async function sheetPatchBy(sheet, column, value, data){
  const url = `${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`;
  const r = await fetch(url,{ method:"PATCH", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ data }) });
  if(!r.ok){ const t=await r.text(); throw new Error("Falha ao atualizar: "+t); } return r.json();
}

/* ===== Tokens/Link ===== */
function randomToken(len=22){ const a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"; let s=""; for(let i=0;i<len;i++) s+=a[Math.floor(Math.random()*a.length)]; return s; }
function toISODate(d=new Date()){ return d.toISOString(); }
function plusDays(days){ const d=new Date(); d.setDate(d.getDate()+days); return d.toISOString(); }
async function getActiveTokenForCPF(cpf){
  try{
    const rows = await sheetSearch(SHEETS.TOKENS, { cpf });
    const now = new Date();
    const valid = (rows||[]).filter(r=>{
      const notDisabled = String(r.disabled||"não").toLowerCase()!=="sim";
      const okDate = !r.expires_at || new Date(r.expires_at) > now;
      return notDisabled && okDate;
    });
    return valid[0] || null;
  }catch(e){ return null; }
}
async function getOrCreatePatientLink(cpf){
  let tk = await getActiveTokenForCPF(cpf);
  if(!tk){
    const token = randomToken();
    const row = { token, cpf, created_at: toISODate(), expires_at: plusDays(30), disabled:"não", uses:"0", last_access_at:"" };
    await sheetCreate(SHEETS.TOKENS, row); tk = row;
  }
  return `${PATIENT_PORTAL_URL}?token=${encodeURIComponent(tk.token)}`;
}

/* ===== Login ===== */
async function tryAuthVariants(user, pass){
  const combos=[ {u:"login",p:"senha"}, {u:"usuario",p:"senha"}, {u:"email",p:"senha"}, {u:"Login",p:"Senha"} ];
  for(const c of combos){ try{ const rows=await sheetSearch(SHEETS.AUTH,{[c.u]:user,[c.p]:pass}); if(rows&&rows.length) return true; }catch(_){} }
  return false;
}
$("#btnLogin").addEventListener("click", doLogin);
["loginUser","loginPass"].forEach(id=>{
  const i=document.getElementById(id);
  i&&i.addEventListener("keydown", e=>{ if(e.key==="Enter") doLogin(); });
});
$("#btnLogout").addEventListener("click", ()=>{
  currentPatient=null; mode="create";
  $("#loginUser").value=""; $("#loginPass").value="";
  hide($("#viewApp")); hide($("#btnLogout")); show($("#viewLogin")); setMsg($("#loginMsg"), "");
});
// Enter no CPF executa a busca
$("#pacCPF").addEventListener("keydown", e=>{
  if(e.key==="Enter"){ carregarPorCPF(); }
});


async function doLogin(){
  const user=$("#loginUser").value.trim(); const pass=$("#loginPass").value; const msg=$("#loginMsg");
  if(!user||!pass){ setMsg(msg,"Preencha usuário e senha.","warn"); return; }
  setMsg(msg,"Verificando…");
  try{
    const ok = await tryAuthVariants(user, pass);
    if(!ok){ setMsg(msg,"Usuário ou senha inválidos.","err"); return; }
    setMsg(msg,"Login ok.","ok");
hide($("#viewLogin")); show($("#viewApp")); show($("#btnLogout"));
await loadTests();
enterLookupMode();
$("#pacCPF").focus();

  }catch(e){ setMsg(msg,"Erro no login: "+e.message,"err"); }
}

/* ===== Estado ===== */
let testsCatalog=[]; let currentPatient=null; let mode="create"; let statusFilter="todos";

/* ===== Catálogo de testes ===== */
async function loadTests(){
  $("#testsInfo").textContent="carregando catálogo…";
  const rows = await sheetSearch(SHEETS.TESTS,{active:"sim"});
  testsCatalog = rows.map(r=>({
      code:  r.code?.trim(),
      label: r.label?.trim(),
      order: Number(r.order||9999),
      source: (r.source||'paciente').trim()
    }))
    .filter(r=>r.code&&r.label)
    .sort((a,b)=>a.order-b.order);
  renderTests();
}

function testStatus(t){
  const code=t.code, done=code+"_FEITO";
  const ja = !!(currentPatient && String(currentPatient[code]||"").toLowerCase()==="sim");
  const feito = !!(currentPatient && String(currentPatient[done]||"").toLowerCase()==="sim");
  if(ja && feito) return "preenchido"; if(ja) return "ja"; return "cadastrar";
}
function normalizeSource(raw){
  const s = (raw||'').toString().toLowerCase()
    .normalize('NFD').replace(/\p{Diacritic}/gu,'').trim();

  // Profissional (testar ANTES de 'prof' para não colidir com "professores")
  if (s.includes('profissional') || s.includes('terapeut') || s.includes('psicolog') || s.includes('neuropsic'))
    return { cls:'profissional', label:'Profissional' };

  // Professores
  if (s.includes('prof'))
    return { cls:'professores', label:'Professores' };

  // Pais/Cuidadores
  if (s.includes('pai') || s.includes('cuidad') || s.includes('respons'))
    return { cls:'pais', label:'Pais/Cuidadores' };

  // Familiares/Amigos
  if (s.includes('fam') || s.includes('amig'))
    return { cls:'familiares', label:'Familiares/Amigos' };

  // Paciente (fallback correto)
  return { cls:'paciente', label:'Paciente' };
}


function renderTests(){
  const grid=$("#testsGrid"); grid.innerHTML="";
  if(!testsCatalog.length){
    $("#testsInfo").className="tag new";
    $("#testsInfo").textContent="Nenhum teste ativo no catálogo (aba Tests).";
    return;
  }
  let cCadastrar=0,cJa=0,cDone=0;

  for(const t of testsCatalog){
    const st = testStatus(t);
    if(statusFilter!=="todos" && st!==statusFilter) continue;

    const src = normalizeSource(t.source);

    const wrap = el("label", { className: `check src-${src.cls}` });

    // 1) TÍTULO
    const codeEl   = el("div", { className:"code",  textContent: t.code });

    // 2) LABEL (subtítulo)
    const labelEl  = el("div", { className:"title", textContent: t.label });

    // 3) SPANS (chip do respondente + status)
    let tagClass="new", tagText="cadastrar";
    if(st==="ja"){ tagClass="ok"; tagText="já registrado"; }
    if(st==="preenchido"){ tagClass="done"; tagText="preenchido"; }
    const tag  = el("span", { className:"tag "+tagClass, textContent: tagText });
    const chip = el("span", { className:"srcchip "+src.cls, textContent: src.label });
    const meta = el("div", { className:"meta" });
    meta.appendChild(chip);
    meta.appendChild(tag);

    // 4) CHECKBOX (fica por último)
    const cb = el("input", { type:"checkbox", id:`cb_${t.code}`, disabled:(st!=="cadastrar") });

    // monta na ordem pedida
    wrap.appendChild(codeEl);
    wrap.appendChild(labelEl);
    wrap.appendChild(meta);
    wrap.appendChild(cb);

    grid.appendChild(wrap);
  }
}

$("#statusFilter").addEventListener("change", e=>{ statusFilter=e.target.value; renderTests(); });

/* ===== Paciente ===== */
async function carregarPorCPF(){
  const cpf=onlyDigits($("#pacCPF").value);
  if(!cpf){ setMsg($("#pacMsg"),"Digite um CPF.","warn"); return; }
  if(!validaCPF(cpf)){ setMsg($("#pacMsg"),"CPF inválido.","err"); return; }

  setMsg($("#pacMsg"),"Buscando cadastro…");
  const found=await sheetSearch(SHEETS.PATIENTS,{cpf});

  if(found && found.length){
    // MODO UPDATE (paciente existe)
    currentPatient=found[0]; mode="update";
    $("#pacNome").value=currentPatient.nome||"";
    $("#pacNasc").value=(currentPatient.data_nascimento||"").slice(0,10);
    $("#pacEmail").value=currentPatient.email||"";
    const w=currentPatient.whatsapp||"";
    $("#pacWhats").value=w||""; if(w) formatWhatsInput($("#pacWhats"));
    setMsg($("#pacMsg"),"Cadastro encontrado.","ok");

    // abre form + testes
    show($("#pacForm"));
    show($("#testsWrap"));
  }else{
    currentPatient=null; mode="create";
    $("#pacNome").value=""; $("#pacNasc").value="";
    $("#pacEmail").value=""; $("#pacWhats").value="";
    setMsg($("#pacMsg"),"CPF sem cadastro. Preencha os dados e selecione os testes para cadastrar.","warn");
    show($("#pacForm"));
    show($("#testsWrap"));
  }
  renderTests();
}


async function salvar(){
  try{
    const btn=$("#btnSalvar"); btn.disabled=true; btn.textContent="Salvando…";
    const nome=$("#pacNome").value.trim(); const cpf=onlyDigits($("#pacCPF").value); const nascISO=toISODateFromInput($("#pacNasc").value);
    const email=$("#pacEmail").value.trim(); const whatsRaw=$("#pacWhats").value; const whatsE164=normalizeWhats(whatsRaw);
    if(!nome){ setMsg($("#pacMsg"),"Informe o nome.","warn"); throw new Error(); }
    if(!validaCPF(cpf)){ setMsg($("#pacMsg"),"CPF inválido.","err"); throw new Error(); }
    if(!nascISO){ setMsg($("#pacMsg"),"Informe a data de nascimento.","warn"); throw new Error(); }
    if(email && !isValidEmail(email)){ setMsg($("#pacMsg"),"E-mail inválido.","warn"); throw new Error(); }
    if(whatsRaw && !whatsE164){ setMsg($("#pacMsg"),"WhatsApp inválido. Use DDD + número.","warn"); throw new Error(); }

    let exists=null; try{ const f=await sheetSearch(SHEETS.PATIENTS,{cpf}); if(f && f.length){ exists=f[0]; } }catch(_){}
    if(mode==="create" && exists){ currentPatient=exists; mode="update"; }

    if(mode==="create"){
      const row={ nome, cpf, data_nascimento:nascISO, created_at:nowDateTimeLocal(), email, whatsapp:whatsE164 };
      for(const t of testsCatalog){ const checked=document.querySelector(`#cb_${t.code}`)?.checked; row[t.code]=checked?"sim":"não"; }
      await sheetCreate(SHEETS.PATIENTS,row); currentPatient=row; setMsg($("#pacMsg"),"Cadastro criado com sucesso.","ok");
      renderTests();
    }else{
      const update={ nome, data_nascimento:nascISO, email, whatsapp:whatsE164 }; let marcou=false;
      for(const t of testsCatalog){ const ja=!!(currentPatient && String(currentPatient[t.code]||"").toLowerCase()==="sim"); const cb=document.querySelector(`#cb_${t.code}`); if(cb && !ja && cb.checked){ update[t.code]="sim"; marcou=true; } }
      await sheetPatchBy(SHEETS.PATIENTS,"cpf",cpf,update);
      setMsg($("#pacMsg"), marcou? "Cadastro atualizado: novos testes liberados." : "Cadastro atualizado.","ok");
    await carregarPorCPF();
    }
  }catch(e){ if(e && e.message) console.error(e.message); }
  finally{ const btn=$("#btnSalvar"); btn.disabled=false; btn.textContent="Salvar"; }
}

/* ===== Ações ===== */
$("#btnBuscar").addEventListener("click", carregarPorCPF);
$("#btnSalvar").addEventListener("click", salvar);
$("#pacCPF").addEventListener("blur", ()=>{ const d=onlyDigits($("#pacCPF").value); if(d.length===11 && validaCPF(d)) carregarPorCPF(); });

// Copiar link p/ WhatsApp manual
$("#btnCopyLink").addEventListener("click", async ()=>{
  const cpf = onlyDigits($("#pacCPF").value);
  if(!validaCPF(cpf)){ setMsg($("#pacMsg"), "CPF inválido.", "err"); return; }
  try{
    const nome = $("#pacNome").value.trim() || (currentPatient?.nome || "Paciente");
    const link = await getOrCreatePatientLink(cpf);
    const texto = `Olá, tudo bem? ${nome}! Segue seu link de acesso aos formulários. OBS:. Os que tiverem a observação de copiar link, você deve clicar no botão (irá copiar o link para ser enviado para um familiar ou amigo que lhe conheça para responder com informações ao seu respeito). ${link}`;
    if(navigator.clipboard && window.isSecureContext){
      await navigator.clipboard.writeText(texto);
    }else{
      const ta = document.createElement("textarea");
      ta.value = texto; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); ta.remove();
    }
    setMsg($("#pacMsg"), "Link copiado! Cole no WhatsApp do paciente. ✔️", "ok");
  }catch(e){
    setMsg($("#pacMsg"), "Erro ao gerar/copiar link: "+e.message, "err");
  }
});

</script>
</body>
</html>

