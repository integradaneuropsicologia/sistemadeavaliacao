<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cadastro de Pacientes — Integrada Neuropsicologia</title>
  <meta name="description" content="Login e cadastro de pacientes com liberação de testes por SheetDB." />
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --pri:#4f46e5;
      --line:#1f2937;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .wrap{max-width:960px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:20px}
    h1,h2{margin:0 0 12px}
    h1{font-size:1.4rem}
    h2{font-size:1.05rem;color:var(--muted)}
    label{display:block;font-weight:600;margin:10px 0 6px}
    input,button,select{font:inherit}
    input[type="text"], input[type="password"], input[type="date"]{
      width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--text)
    }
    select{
      padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--text)
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .btn{display:inline-flex;align-items:center;gap:10px;background:var(--pri);border:none;color:#fff;padding:12px 16px;border-radius:10px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.sec{background:#334155}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .msg{margin:10px 0;padding:10px;border-radius:8px}
    .msg.ok{background:#052e1a;color:#b3f7c1;border:1px solid #114d2a}
    .msg.err{background:#3b0d0d;color:#ffd0d0;border:1px solid #5b1919}
    .msg.warn{background:#3a2903;color:#ffe6b0;border:1px solid #5c4307}
    .grid-tests{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px;margin-top:10px}
    .check{display:flex;align-items:flex-start;gap:10px;padding:10px;border:1px solid var(--line);border-radius:10px;background:#0b1220}
    .check small{display:block;color:var(--muted)}
    .tag{font-size:.75rem;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted)}
    .tag.ok{background:#09331b;color:#9af0b1;border-color:#124d29}          /* já registrado */
    .tag.done{background:#07263a;color:#b9e7ff;border-color:#0a3c66}        /* preenchido */
    .tag.new{background:#2a2a2a}                                            /* cadastrar */
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .topbar .brand{font-weight:700}
    .hidden{display:none !important}
    @media (max-width:720px){.row,.row3{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">Integrada Neuropsicologia — Painel</div>
      <div>
        <button id="btnLogout" class="btn sec hidden">Sair</button>
      </div>
    </div>

    <!-- LOGIN -->
    <section id="viewLogin" class="card">
      <h1>Entrar</h1>
      <p class="muted">Use seu usuário e senha cadastrados na aba <strong>Auth</strong>.</p>
      <div class="row">
        <div>
          <label>Usuário</label>
          <input id="loginUser" type="text" autocomplete="username" />
        </div>
        <div>
          <label>Senha</label>
          <input id="loginPass" type="password" autocomplete="current-password" />
        </div>
      </div>
      <div class="toolbar">
        <button id="btnLogin" class="btn">Entrar</button>
      </div>
      <div id="loginMsg" class="msg hidden"></div>
    </section>

    <!-- CADASTRO -->
    <section id="viewApp" class="card hidden">
      <h1>Cadastro de Paciente</h1>
      <h2>Dados do paciente</h2>
      <div class="row3">
        <div>
          <label>Nome completo</label>
          <input id="pacNome" type="text" placeholder="Ex.: Ana Paula Gomes do Nascimento" />
        </div>
        <div>
          <label>CPF (somente números)</label>
          <input id="pacCPF" type="text" inputmode="numeric" maxlength="14" placeholder="000.000.000-00" />
        </div>
        <div>
          <label>Data de nascimento</label>
          <input id="pacNasc" type="date" />
        </div>
      </div>

      <div class="toolbar">
        <button id="btnBuscar" class="btn sec">Buscar/Carregar por CPF</button>
        <button id="btnSalvar" class="btn">Salvar</button>
      </div>
      <div id="pacMsg" class="msg hidden"></div>

      <h2 style="margin-top:18px;">Testes</h2>
      <div class="toolbar" style="margin-bottom:6px;">
        <label for="statusFilter" style="margin:0;align-self:center;">Filtrar por status</label>
        <select id="statusFilter" aria-label="Filtrar por status">
          <option value="todos">Todos</option>
          <option value="cadastrar">Cadastrar</option>
          <option value="ja">Já registrados</option>
          <option value="preenchido">Preenchido</option>
        </select>
        <div id="testsInfo" class="tag new">carregando catálogo…</div>
      </div>
      <div id="testsGrid" class="grid-tests" aria-live="polite"></div>
    </section>
  </div>

<script>
/** ===========================
 *  CONFIGURAÇÃO
 *  =========================== */
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8"; // seu endpoint
const SHEETS = { AUTH:"Auth", TESTS:"Tests", PATIENTS:"Patients" };

// (opcional) prefixo para colunas de testes na aba Patients (se usar, aplique nas colunas também)
const TEST_PREFIX = ""; // ex.: "TEST_" -> então coluna vira TEST_IHS, etc.
const DONE_SUFFIX = "_FEITO"; // coluna opcional <CODE>_FEITO = sim => "Preenchido"

// ============================
// UTILITÁRIOS
// ============================
const $ = sel => document.querySelector(sel);
const el = (tag, opts={}) => Object.assign(document.createElement(tag), opts);

function show(node){ node.classList.remove("hidden"); }
function hide(node){ node.classList.add("hidden"); }
function setMsg(box, text, type="ok"){
  box.textContent = text;
  box.className = "msg " + (type || "");
  text ? show(box) : hide(box);
}
function onlyDigits(str){ return (str||"").replace(/\D+/g,""); }

function validaCPF(cpf){
  cpf = onlyDigits(cpf);
  if (!cpf || cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;
  let soma = 0, resto;
  for (let i=1;i<=9;i++) soma += parseInt(cpf.substring(i-1,i))*(11-i);
  resto = (soma*10)%11; if (resto===10||resto===11) resto=0;
  if (resto !== parseInt(cpf.substring(9,10))) return false;
  soma=0;
  for (let i=1;i<=10;i++) soma += parseInt(cpf.substring(i-1,i))*(12-i);
  resto = (soma*10)%11; if (resto===10||resto===11) resto=0;
  return resto === parseInt(cpf.substring(10,11));
}
function toISODateFromInput(dateStr){ return dateStr || ""; } // input date já retorna AAAA-MM-DD
function nowDateTimeLocal(){
  const d = new Date();
  const pad = n => (n<10?'0':'')+n;
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

// ============================
// CHAMADAS À SHEETDB
// ============================
async function sheetSearch(sheet, params){
  const usp = new URLSearchParams(params);
  const url = `${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error("Falha ao buscar em "+sheet);
  return r.json();
}
async function sheetCreate(sheet, row){
  const url = `${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`;
  const r = await fetch(url, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ data:[row] })
  });
  if(!r.ok) { const t = await r.text(); throw new Error("Falha ao criar: "+t); }
  return r.json();
}
async function sheetPatchBy(sheet, column, value, data){
  const url = `${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`;
  const r = await fetch(url, {
    method:"PATCH",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ data })
  });
  if(!r.ok){ const t = await r.text(); throw new Error("Falha ao atualizar: "+t); }
  return r.json();
}

// ============================
// ESTADO
// ============================
let testsCatalog = [];    // [{code,label,order}]
let currentPatient = null;
let mode = "create";      // "create" | "update"
let statusFilter = "todos"; // "todos" | "cadastrar" | "ja" | "preenchido"

// ============================
// LOGIN
// ============================
$("#btnLogin").addEventListener("click", async ()=>{
  const user = $("#loginUser").value.trim();
  const pass = $("#loginPass").value.trim();
  try{
    if(!user || !pass){ setMsg($("#loginMsg"), "Preencha usuário e senha.", "warn"); return; }
    const found = await sheetSearch(SHEETS.AUTH, {login:user, senha:pass});
    if(found && found.length){
      setMsg($("#loginMsg"), "Login ok.", "ok");
      hide($("#viewLogin")); show($("#viewApp")); show($("#btnLogout"));
      await loadTests();
      $("#pacCPF").focus();
    }else{
      setMsg($("#loginMsg"), "Usuário ou senha inválidos.", "err");
    }
  }catch(e){
    setMsg($("#loginMsg"), "Erro no login: "+e.message, "err");
  }
});
$("#btnLogout").addEventListener("click", ()=>{
  currentPatient = null; mode = "create";
  $("#loginUser").value = ""; $("#loginPass").value="";
  hide($("#viewApp")); hide($("#btnLogout")); show($("#viewLogin"));
  setMsg($("#loginMsg"), "");
});

// ============================
// CATÁLOGO DE TESTES
// ============================
async function loadTests(){
  $("#testsInfo").textContent = "carregando catálogo…";
  const rows = await sheetSearch(SHEETS.TESTS, {active:"sim"});
  testsCatalog = rows
    .map(r => ({ code:r.code?.trim(), label:r.label?.trim(), order: Number(r.order||9999) }))
    .filter(r => r.code && r.label)
    .sort((a,b)=>a.order-b.order);
  renderTests();
}

// calcula status do teste para o paciente atual
function testStatus(t){
  const codeCol = (TEST_PREFIX ? TEST_PREFIX + t.code : t.code);
  const doneCol = codeCol + DONE_SUFFIX;
  const alreadySim = !!(currentPatient && String(currentPatient[codeCol]||"").toLowerCase()==="sim");
  const isDone    = !!(currentPatient && String(currentPatient[doneCol]||"").toLowerCase()==="sim");
  if (alreadySim && isDone) return "preenchido";
  if (alreadySim && !isDone) return "ja";
  return "cadastrar";
}

function renderTests(){
  const grid = $("#testsGrid");
  grid.innerHTML = "";

  if(!testsCatalog.length){
    $("#testsInfo").className="tag new";
    $("#testsInfo").textContent = "Nenhum teste ativo no catálogo (aba Tests).";
    return;
  }

  // contagens
  let cCadastrar=0, cJa=0, cDone=0;
  for(const t of testsCatalog){
    const st = testStatus(t);
    if(st==="cadastrar") cCadastrar++;
    else if(st==="ja") cJa++;
    else if(st==="preenchido") cDone++;
  }

  // atualiza info (mostra filtro atual também)
  const filterLabel = {todos:"Todos", cadastrar:"Cadastrar", ja:"Já registrados", preenchido:"Preenchido"}[statusFilter];
  $("#testsInfo").className="tag";
  $("#testsInfo").textContent = `Ativos: ${testsCatalog.length} • Cadastrar: ${cCadastrar} • Já: ${cJa} • Preenchido: ${cDone} • Filtro: ${filterLabel}`;

  // render com filtro
  for(const t of testsCatalog){
    const st = testStatus(t);
    if(statusFilter!=="todos" && st!==statusFilter) continue;

    const codeCol = (TEST_PREFIX ? TEST_PREFIX + t.code : t.code);
    const alreadySim = !!(currentPatient && String(currentPatient[codeCol]||"").toLowerCase()==="sim");
    const isDone = (st==="preenchido");

    // rótulo + classe
    let tagClass = "new";
    let tagText  = "cadastrar";
    if (st==="ja"){ tagClass = "ok"; tagText="já registrado"; }
    if (st==="preenchido"){ tagClass = "done"; tagText="preenchido"; }

    // bloco visual
    const wrap = el("label", {className:"check"});
    // checkbox habilitado só quando status = cadastrar
    const cb = el("input", {type:"checkbox", id:`cb_${t.code}`, disabled: (st!=="cadastrar")});
    const box = el("div");
    const title = el("div", {textContent: t.label});
    const sub = el("small", {textContent: codeCol});
    const tag = el("span", {className: "tag "+tagClass, textContent: tagText});

    box.appendChild(title);
    box.appendChild(sub);
    wrap.appendChild(cb);
    wrap.appendChild(box);
    wrap.appendChild(tag);
    grid.appendChild(wrap);
  }
}

// filtro de status
$("#statusFilter").addEventListener("change", (e)=>{
  statusFilter = e.target.value;
  renderTests();
});

// ============================
// PACIENTE
// ============================
async function carregarPorCPF(){
  const cpfInput = $("#pacCPF").value;
  const cpf = onlyDigits(cpfInput);
  if(!cpf){ setMsg($("#pacMsg"), "Digite um CPF.", "warn"); return; }
  if(!validaCPF(cpf)){ setMsg($("#pacMsg"), "CPF inválido.", "err"); return; }

  setMsg($("#pacMsg"), "Buscando cadastro…");
  const found = await sheetSearch(SHEETS.PATIENTS, {cpf});
  if(found && found.length){
    currentPatient = found[0];
    mode = "update";
    $("#pacNome").value = currentPatient.nome || "";
    $("#pacNasc").value = (currentPatient.data_nascimento || "").slice(0,10);
    setMsg($("#pacMsg"), "Cadastro encontrado.", "ok");
  }else{
    currentPatient = null;
    mode = "create";
    setMsg($("#pacMsg"), "CPF sem cadastro. Você está no modo NOVO cadastro.", "warn");
  }
  renderTests();
}

async function salvar(){
  try{
    const nome = $("#pacNome").value.trim();
    const cpf = onlyDigits($("#pacCPF").value);
    const nascISO = toISODateFromInput($("#pacNasc").value);
    if(!nome){ setMsg($("#pacMsg"), "Informe o nome.", "warn"); return; }
    if(!validaCPF(cpf)){ setMsg($("#pacMsg"), "CPF inválido.", "err"); return; }
    if(!nascISO){ setMsg($("#pacMsg"), "Informe a data de nascimento.", "warn"); return; }

    // anti-duplicidade: se já existe, muda para update
    let exists = null;
    try{
      const found = await sheetSearch(SHEETS.PATIENTS, {cpf});
      if(found && found.length){ exists = found[0]; }
    }catch(e){}

    if(mode==="create" && exists){ currentPatient = exists; mode="update"; }

    if(mode==="create"){
      // novo: grava sim/não para TODOS os testes (mesmo filtrados)
      const row = { nome, cpf, data_nascimento: nascISO, created_at: nowDateTimeLocal() };
      for(const t of testsCatalog){
        const codeCol = (TEST_PREFIX ? TEST_PREFIX + t.code : t.code);
        const checked = document.querySelector(`#cb_${t.code}`)?.checked; // pode estar fora do filtro
        row[codeCol] = checked ? "sim" : "não";
      }
      await sheetCreate(SHEETS.PATIENTS, row);
      setMsg($("#pacMsg"), "Cadastro criado com sucesso.", "ok");
      currentPatient = row; renderTests();
    }else{
      // update: só marca 'sim' nos selecionados que ainda não eram sim
      const update = { nome, data_nascimento: nascISO };
      let marcouAlgoNovo = false;
      for(const t of testsCatalog){
        const codeCol = (TEST_PREFIX ? TEST_PREFIX + t.code : t.code);
        const jaSim = !!(currentPatient && String(currentPatient[codeCol]||"").toLowerCase()==="sim");
        const cb = document.querySelector(`#cb_${t.code}`);
        if(cb && !jaSim && cb.checked){
          update[codeCol] = "sim";
          marcouAlgoNovo = true;
        }
      }
      await sheetPatchBy(SHEETS.PATIENTS, "cpf", cpf, update);
      setMsg($("#pacMsg"), marcouAlgoNovo ? "Cadastro atualizado: novos testes liberados." : "Cadastro atualizado.", "ok");
      await carregarPorCPF();
    }
  }catch(e){
    setMsg($("#pacMsg"), e.message, "err");
  }
}

// Eventos principais
$("#btnBuscar").addEventListener("click", carregarPorCPF);
$("#btnSalvar").addEventListener("click", salvar);
$("#pacCPF").addEventListener("blur", ()=>{
  const digits = onlyDigits($("#pacCPF").value);
  if(digits.length===11 && validaCPF(digits)) carregarPorCPF();
});
</script>
</body>
</html>
